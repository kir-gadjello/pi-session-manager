{"taskSetName": "settings-system-completion", "projectName": "设置系统完善", "outputDir": "./task", "goals": [{"metric": "总体完成度", "before": "65%", "target": "90%+", "improvement": "38%"}, {"metric": "持久化实现", "before": "30%", "target": "100%", "improvement": "233%"}, {"metric": "设置应用", "before": "5%", "target": "80%+", "improvement": "1500%"}, {"metric": "设置生效数量", "before": "1/23", "target": "18+/23", "improvement": "1700%"}], "tasks": [{"id": "001", "title": "实现 Tauri 后端存储命令", "priority": "High", "estimated": "3h", "description": "在 Rust 后端实现设置的加载和保存命令，支持文件系统持久化", "steps": ["在 src-tauri/src/commands.rs 中添加 load_settings 命令", "在 src-tauri/src/commands.rs 中添加 save_settings 命令", "定义 SettingsFile 结构体（用于 JSON 序列化）", "实现从 ~/.pi/session-manager/settings.json 读取设置", "实现设置写入到文件系统（自动创建目录）", "添加错误处理和日志记录", "在 src-tauri/src/lib.rs 中注册新命令", "编写单元测试验证读写功能"], "dependencies": [], "acceptance": ["load_settings 命令可正常调用并返回 AppSettings", "save_settings 命令可正常调用并写入文件", "设置文件保存在 ~/.pi/session-manager/settings.json", "错误情况有清晰的错误消息", "单元测试通过"]}, {"id": "002", "title": "创建 Settings Context 和 Hook", "priority": "High", "estimated": "4h", "description": "创建全局设置管理机制，使用 React Context 和自定义 Hook", "steps": ["创建 src/contexts/SettingsContext.tsx", "定义 SettingsProvider 组件", "创建 src/hooks/useSettings.ts", "实现设置状态管理（加载、更新、保存）", "实现设置变更监听机制", "添加设置重置功能", "添加设置持久化逻辑（localStorage + Tauri）", "导出 useSettings Hook", "在 App.tsx 中包裹 SettingsProvider"], "dependencies": ["001"], "acceptance": ["SettingsContext 和 useSettings Hook 可正常导入使用", "组件可通过 useSettings 获取和更新设置", "设置变更自动保存到后端", "设置加载失败有降级方案（使用 localStorage）", "设置重置功能正常工作"]}, {"id": "003", "title": "重构 SettingsPanel 使用 Context", "priority": "High", "estimated": "2h", "description": "将 SettingsPanel 从独立状态管理改为使用全局 Settings Context", "steps": ["在 SettingsPanel 中导入 useSettings Hook", "移除 SettingsPanel 内部的 settings state", "移除 loadSettings 和 saveSettings 函数", "使用 useSettings 提供的 settings 和 updateSetting", "简化重置逻辑（调用 useSettings 的 reset）", "测试设置加载和保存功能", "验证设置持久化到文件系统"], "dependencies": ["002"], "acceptance": ["SettingsPanel 使用全局设置状态", "设置保存到文件系统（不再仅 localStorage）", "设置变更在组件间同步", "UI 交互正常无变化"]}, {"id": "004", "title": "应用外观设置（Theme, FontSize, MessageSpacing）", "priority": "High", "estimated": "3h", "description": "实现主题、字体大小、消息间距等外观设置的实际应用", "steps": ["在 index.css 中定义 CSS 变量（--font-size-base, --spacing-base）", "创建 src/hooks/useAppearance.ts Hook", "根据 settings.appearance.theme 动态切换主题类名", "根据 settings.appearance.fontSize 应用字体大小", "根据 settings.appearance.messageSpacing 应用间距", "在 App.tsx 中应用主题类名到根元素", "测试主题切换（暗色/浅色/跟随系统）", "测试字体大小切换", "测试消息间距切换"], "dependencies": ["002"], "acceptance": ["主题切换立即生效（无需刷新）", "字体大小切换影响所有文本", "消息间距切换影响会话列表", "跟随系统主题正常工作", "设置持久化到文件系统"]}, {"id": "005", "title": "应用代码块主题设置", "priority": "Medium", "estimated": "2h", "description": "实现代码块高亮主题的切换功能", "steps": ["准备 4 种代码块主题的 CSS 样式（github, monokai, dracula, one-dark）", "创建 src/components/CodeBlockTheme.tsx 组件", "根据 settings.appearance.codeBlockTheme 应用对应样式", "在 SessionViewer 中的代码块组件应用主题", "测试各主题的显示效果", "确保主题切换不影响代码复制功能"], "dependencies": ["004"], "acceptance": ["代码块主题切换立即生效", "4 种主题样式正确显示", "代码复制功能正常", "主题持久化到文件系统"]}, {"id": "006", "title": "修复 sidebarWidth 数据一致性", "priority": "High", "estimated": "1.5h", "description": "统一 SessionViewer 和 SettingsPanel 中的 sidebarWidth 管理", "steps": ["移除 SessionViewer 中独立的 localStorage key", "SessionViewer 使用 useSettings Hook 获取 sidebarWidth", "统一默认值为 320px", "SessionViewer 拖拽调整时调用 updateSetting", "SettingsPanel 中添加 sidebarWidth 滑块控制", "测试拖拽调整和滑块调整的同步", "验证设置持久化"], "dependencies": ["002"], "acceptance": ["sidebarWidth 只有一个数据源", "拖拽调整和滑块调整同步", "设置持久化到文件系统", "侧边栏宽度在所有组件中一致"]}, {"id": "007", "title": "应用会话设置（ViewMode, AutoRefresh）", "priority": "High", "estimated": "2.5h", "description": "实现默认视图模式和自动刷新设置的应用", "steps": ["在 App.tsx 中使用 useSettings 获取 defaultViewMode", "应用 defaultViewMode 到初始 viewMode state", "创建自动刷新 Hook（useAutoRefresh）", "根据 autoRefresh 和 refreshInterval 启动/停止定时器", "定时器触发时调用 loadSessions", "组件卸载时清理定时器", "测试自动刷新功能", "测试不同刷新间隔"], "dependencies": ["002"], "acceptance": ["启动时使用 saved 的 defaultViewMode", "自动刷新开关控制会话列表刷新", "刷新间隔可调整", "定时器正确清理（无内存泄漏）", "设置持久化到文件系统"]}, {"id": "008", "title": "应用会话预览设置（ShowPreview, PreviewLines）", "priority": "Medium", "estimated": "2h", "description": "实现消息预览显示和预览行数控制", "steps": ["在 SessionList 组件中使用 useSettings", "根据 showMessagePreview 控制预览显示/隐藏", "根据 previewLines 控制显示行数", "使用 CSS line-clamp 实现行数限制", "测试预览开关", "测试不同预览行数", "确保不影响搜索功能"], "dependencies": ["007"], "acceptance": ["预览开关立即生效", "预览行数控制正确", "超长文本正确截断", "设置持久化到文件系统"]}, {"id": "009", "title": "应用搜索设置（SearchMode, CaseSensitive, IncludeTools）", "priority": "High", "estimated": "2h", "description": "实现搜索相关设置的应用", "steps": ["在 SearchPanel 中使用 useSettings", "根据 defaultSearchMode 设置初始搜索模式", "根据 caseSensitive 传递搜索参数", "根据 includeToolCalls 传递搜索参数", "测试不同搜索模式", "测试大小写敏感", "测试包含/排除工具调用", "根据 highlightMatches 应用高亮样式"], "dependencies": ["002"], "acceptance": ["搜索模式默认值正确", "大小写敏感开关生效", "工具调用包含开关生效", "高亮匹配开关生效", "设置持久化到文件系统"]}, {"id": "010", "title": "应用导出设置（Format, Metadata, Timestamps）", "priority": "Medium", "estimated": "1.5h", "description": "实现导出相关设置的应用", "steps": ["在 ExportDialog 中使用 useSettings", "根据 defaultFormat 设置默认导出格式", "根据 includeMetadata 控制元数据包含", "根据 includeTimestamps 控制时间戳包含", "测试各导出格式", "测试元数据开关", "测试时间戳开关"], "dependencies": ["002"], "acceptance": ["导出格式默认值正确", "元数据开关生效", "时间戳开关生效", "设置持久化到文件系统"]}, {"id": "011", "title": "应用终端设置（Terminal, PiCommandPath）", "priority": "Medium", "estimated": "2h", "description": "实现终端相关设置的应用", "steps": ["在会话打开功能中读取设置", "根据 defaultTerminal 选择终端类型", "实现 iTerm2 打开逻辑", "实现 Terminal.app 打开逻辑", "实现 VS Code 终端打开逻辑", "实现自定义终端命令逻辑（支持 {path} 占位符）", "使用 piCommandPath 执行命令", "测试各终端类型", "测试自定义命令"], "dependencies": ["002"], "acceptance": ["各终端类型正确打开会话", "自定义命令支持 {path} 占位符", "piCommandPath 正确使用", "设置持久化到文件系统"]}, {"id": "012", "title": "应用高级设置（SessionDir, Cache, Debug）", "priority": "Medium", "estimated": "2h", "description": "实现高级设置的应用", "steps": ["在会话扫描功能中读取 sessionDir", "支持 ~ 路径展开", "根据 cacheEnabled 控制缓存逻辑", "根据 maxCacheSize 限制缓存大小", "根据 debugMode 控制日志输出级别", "实现清除缓存功能（调用后端）", "测试会话目录切换", "测试缓存开关", "测试调试模式"], "dependencies": ["002"], "acceptance": ["会话目录切换生效", "缓存开关生效", "缓存大小限制生效", "调试模式生效（控制台日志）", "清除缓存功能正常", "设置持久化到文件系统"]}, {"id": "013", "title": "添加设置输入验证", "priority": "Medium", "estimated": "2h", "description": "为所有设置输入添加验证逻辑，防止无效配置", "steps": ["创建 src/utils/settingsValidation.ts", "定义 ValidationRule 接口", "定义 ValidationError 接口", "为每个设置项定义验证规则", "实现 validateSettings 函数", "在 SettingsPanel 中集成验证", "显示验证错误提示", "阻止无效设置保存", "测试各种无效输入"], "dependencies": ["003"], "acceptance": ["空路径输入被阻止", "超出范围的数值被阻止", "无效格式被阻止", "错误提示清晰友好", "验证规则可扩展"]}, {"id": "014", "title": "统一 Pi Config 处理", "priority": "Medium", "estimated": "2h", "description": "将 Pi Config 纳入 AppSettings 统一管理", "steps": ["在 AppSettings 中添加 piConfig 字段", "定义 PiConfigSettings 类型", "修改 PiConfigSettings 组件使用 useSettings", "移除 PiConfigSettings 独立的 Tauri 调用", "将 Pi Config 保存逻辑集成到 Context", "测试 Skills/Prompts 启用切换", "验证 settings.json 写入", "确保向后兼容"], "dependencies": ["002"], "acceptance": ["Pi Config 在 AppSettings 中管理", "Skills/Prompts 切换正常", "settings.json 正确写入", "所有设置统一持久化", "向后兼容旧数据"]}, {"id": "015", "title": "添加未保存提示", "priority": "Low", "estimated": "1h", "description": "在用户尝试关闭设置面板时提示未保存的更改", "steps": ["在 SettingsPanel 中添加 hasChanges state", "使用 useEffect 监听 settings 变化", "对比当前设置和已保存设置", "修改 onClose 回调接受 onConfirm", "显示确认对话框", "提供保存、放弃、返回选项", "测试未保存提示", "测试保存后关闭"], "dependencies": ["003"], "acceptance": ["有更改时关闭显示提示", "无更改时直接关闭", "保存选项正确保存", "放弃选项恢复原值", "返回选项保持编辑"]}, {"id": "016", "title": "实现设置搜索功能", "priority": "Low", "estimated": "2h", "description": "在设置面板中添加搜索框，快速定位设置项", "steps": ["在 SettingsPanel 添加搜索输入框", "创建设置项索引数据结构", "实现搜索过滤逻辑", "高亮匹配的设置项", "自动展开匹配项所在的分类", "支持键盘快捷键（Cmd+K）", "测试搜索功能", "测试中文搜索"], "dependencies": ["003"], "acceptance": ["搜索框正常工作", "匹配项高亮显示", "分类自动展开", "快捷键 Cmd+K 聚焦搜索", "搜索性能良好"]}, {"id": "017", "title": "添加键盘快捷键", "priority": "Low", "estimated": "1h", "description": "为常用操作添加键盘快捷键", "steps": ["定义快捷键映射（Cmd+S 保存, Cmd+R 重置, Esc 关闭）", "在 SettingsPanel 中集成快捷键", "使用 useKeyboardShortcuts Hook", "显示快捷键提示", "测试各快捷键", "确保不冲突应用级快捷键"], "dependencies": ["003"], "acceptance": ["Cmd+S 保存设置", "Cmd+R 重置设置", "Esc 关闭面板", "快捷键提示显示", "无冲突"]}, {"id": "018", "title": "设置导入/导出功能", "priority": "Low", "estimated": "2h", "description": "支持将设置导出为 JSON 文件，或从文件导入", "steps": ["在 AdvancedSettings 添加导入/导出按钮", "实现导出功能（生成 JSON 文件）", "实现导入功能（读取 JSON 文件）", "添加导入验证", "导入前显示确认对话框", "测试导出功能", "测试导入功能", "测试无效文件处理"], "dependencies": ["013"], "acceptance": ["导出生成正确 JSON", "导入正确恢复设置", "无效文件显示错误", "导入前有确认", "设置立即生效"]}, {"id": "019", "title": "编写测试用例", "priority": "Medium", "estimated": "3h", "description": "为设置系统编写单元测试和集成测试", "steps": ["创建 src/contexts/__tests__/SettingsContext.test.tsx", "测试设置加载逻辑", "测试设置更新逻辑", "测试设置保存逻辑", "测试设置重置逻辑", "创建 src/hooks/__tests__/useSettings.test.ts", "测试 Hook 行为", "测试验证逻辑", "测试错误处理", "确保覆盖率 > 80%"], "dependencies": ["002", "013"], "acceptance": ["所有核心功能有测试", "测试覆盖率 > 80%", "测试通过", "CI 集成"]}, {"id": "020", "title": "文档更新", "priority": "Low", "estimated": "1.5h", "description": "更新项目文档，记录设置系统的使用方法", "steps": ["在 README.md 添加设置系统说明", "创建 docs/settings.md 详细文档", "记录所有设置项的说明", "添加示例配置", "添加常见问题", "更新 CHANGELOG.md"], "dependencies": ["018"], "acceptance": ["README 有设置说明", "docs/settings.md 创建", "所有设置项有说明", "有示例配置", "CHANGELOG 更新"]}, {"id": "021", "title": "端到端测试", "priority": "Medium", "estimated": "2h", "description": "进行完整的端到端测试，验证所有设置功能", "steps": ["测试所有设置项的保存", "测试所有设置项的加载", "测试所有设置项的应用", "测试设置持久化（重启应用）", "测试设置导入/导出", "测试设置验证", "测试多组件同步", "记录测试结果", "修复发现的问题"], "dependencies": ["019"], "acceptance": ["所有设置项功能正常", "设置持久化正确", "多组件同步正确", "无严重 bug", "测试报告完成"]}]}